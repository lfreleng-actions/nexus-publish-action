---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025 The Linux Foundation

# Action test/validation workflow
name: 'Test GitHub Action ðŸ§ª'

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

permissions: {}

env:
  CHART_REPOSITORY: 'lfreleng-actions/test-makefile-helm-chart'
  CHARTS_BUILD_DIR: 'test-makefile-helm-chart'

# Publishing tests require a Nexus server and corresponding credential
# A dedicated O-RAN server/instance credential is stored in 1Password
# The variables/secrets are then set in the lfreleng-actions repository
# NEXUS3_SERVER = 'https://nexus3.o-ran-sc.org'
# NEXUS_PASSWORD -> 1Password: nexus-publish-action [Nexus 3]

jobs:
  ### Test the GitHub Action in this Repository ###
  build:
    name: 'Build Helm Charts'
    runs-on: 'ubuntu-latest'
    outputs:
      CHARTS_BUILD_DIR: "${{ env.CHARTS_BUILD_DIR }}"
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a  # v2.13.1
        with:
          egress-policy: 'audit'

      # yamllint disable-line rule:line-length
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: 'Setup Helm'
        # yamllint disable-line rule:line-length
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4  # v4.3.1

      - name: 'Run make'
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/make-action@361e48884a6b7d7b5fcfcb38f399aa14e45127dc  # v0.1.1
        with:
          repository: "${{ env.CHART_REPOSITORY }}"
          path: "${{ env.CHARTS_BUILD_DIR }}"
          make_args: "-C ${{ env.CHARTS_BUILD_DIR }}"

      - name: 'Upload Helm Charts as artefacts'
        # yamllint disable-line rule:line-length
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        with:
          name: "${{ env.CHARTS_BUILD_DIR }}"
          path: "${{ env.CHARTS_BUILD_DIR }}/*.tgz"

  nexus-publish:
    name: 'Publish Helm Charts [O-RAN-SC Nexus 3]'
    # Credential availability: job skips pull requests, but runs on merge
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: 'ubuntu-latest'
    needs:
      - build
    permissions:
      contents: read
    timeout-minutes: 3
    steps:
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a  # v2.13.1
        with:
          egress-policy: 'audit'

      # Required when tested action is local to this repository
      # yamllint disable-line rule:line-length
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: 'Download Helm Charts'
        # yamllint disable-line rule:line-length
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          name: "${{ needs.build.outputs.CHARTS_BUILD_DIR }}"
          path: "${{ needs.build.outputs.CHARTS_BUILD_DIR }}"

      - name: 'Publish Helm Charts'
        uses: ./
        with:
          nexus_server: "${{ vars.NEXUS3_SERVER }}"
          nexus_password: "${{ secrets.NEXUS_PASSWORD }}"
          repository_format: 'raw'
          repository_name: 'helm.snapshot'
          files_path: "${{ needs.build.outputs.CHARTS_BUILD_DIR }}"
          file_pattern: '*.tgz'
          permit_fail: 'false'
